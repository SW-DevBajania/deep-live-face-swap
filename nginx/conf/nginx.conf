worker_processes  1;
events {
    worker_connections  1024;
}

# RTMP configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record off;
            
            # Remove restrictions temporarily for testing
            allow publish all;
            allow play all;
            
            # Low latency settings
            low_latency on;
            buffer 50ms;
            sync 1ms;
            
            # Add debug logging
            access_log logs/rtmp_access.log;
            access_log logs/rtmp_access.log json;
            
            # Add application level logging with correct URLs
            on_publish http://localhost:8000/on_publish;
            on_play http://localhost:8000/on_play;
            on_done http://localhost:8000/on_done;
            
            # Add notification settings
            notify_method get;
            notify_update_timeout 5s;
            notify_update_strict on;
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 80;
        
        # RTMP Statistics
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            add_header Access-Control-Allow-Origin *;
        }

        # RTMP Control
        location /control {
            rtmp_control all;
            add_header Access-Control-Allow-Origin *;
        }

        # Simple auth
        location /auth {
            return 200;
        }
    }

    # Add detailed logging
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" "$http_x_forwarded_for"';
    access_log logs/access.log detailed;
    error_log logs/error.log debug;
}